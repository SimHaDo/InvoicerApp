# Устранение неполадок синхронизации логотипа компании

## Проблема
Логотип компании (`CompanyLogo`) не синхронизируется через iCloud CloudKit между устройствами.

## Исправления

### 1. Улучшенная синхронизация логотипа
- **Добавлен специальный метод `syncCompanyLogo()`** в `CoreDataAdapter`
- **Принудительная синхронизация** при изменении логотипа
- **Проверка размера файла** с автоматическим сжатием при превышении лимитов CloudKit

### 2. Исправлена логика в AppState
- **Упрощена логика обновления** логотипа в `AppState`
- **Прямая синхронизация** через Core Data без двойного сохранения
- **Избежание бесконечных циклов** при загрузке данных

### 3. Добавлена отладочная информация
- **Подробное логирование** процесса синхронизации
- **Мониторинг размера** логотипа и статуса CloudKit
- **Отслеживание ошибок** синхронизации

## Технические детали

### Ограничения CloudKit
- **Максимальный размер бинарных данных**: 10MB
- **Автоматическое сжатие** изображений при превышении лимита
- **Качество сжатия**: 0.5 (50%) для JPEG

### Архитектура синхронизации
```
AppState.logoData → CoreDataAdapter.syncCompanyLogo() → CompanyEntity.logoData → CloudKit
```

### Отладочные сообщения
При изменении логотипа вы увидите следующие сообщения в консоли:
```
AppState: Logo data changed, saving...
CoreDataAdapter: Company logo synced to CloudKit: [размер] bytes
CoreDataStack: Forcing sync to CloudKit...
CoreDataStack: Sync completed
```

## Проверка синхронизации

### 1. Проверьте статус CloudKit
```swift
let isAvailable = await coreDataAdapter.checkCloudKitSyncStatus()
print("CloudKit available: \(isAvailable)")
```

### 2. Проверьте размер логотипа
```swift
if let logoData = appState.logoData {
    print("Logo size: \(logoData.count) bytes")
}
```

### 3. Проверьте наличие компании в Core Data
```swift
if let company = coreDataAdapter.fetchCompany() {
    print("Company found: \(company.name)")
    print("Logo data: \(company.logoData?.count ?? 0) bytes")
}
```

## Возможные проблемы и решения

### Проблема: Логотип не синхронизируется
**Решение**: 
1. Проверьте подключение к iCloud
2. Убедитесь, что CloudKit доступен
3. Проверьте размер логотипа (должен быть < 10MB)

### Проблема: Логотип слишком большой
**Решение**: 
- Система автоматически сжимает изображения
- Качество сжатия: 50% JPEG
- Если сжатие не помогает, уменьшите размер изображения вручную

### Проблема: Синхронизация медленная
**Решение**:
- CloudKit синхронизация может занять время
- Проверьте интернет-соединение
- Убедитесь, что устройства подключены к iCloud

## Тестирование

### На реальном устройстве
1. Установите приложение на два устройства
2. Войдите в один и тот же iCloud аккаунт
3. Добавьте логотип на одном устройстве
4. Подождите несколько минут
5. Проверьте синхронизацию на втором устройстве

### В симуляторе
- CloudKit не работает в симуляторе
- Используйте реальные устройства для тестирования синхронизации

## Мониторинг

Отслеживайте следующие сообщения в консоли:
- `AppState: Logo data changed, saving...`
- `CoreDataAdapter: Company logo synced to CloudKit`
- `CoreDataStack: Forcing sync to CloudKit...`
- `CoreDataStack: Sync completed`

Если синхронизация не работает, проверьте:
1. Статус iCloud аккаунта
2. Подключение к интернету
3. Размер логотипа
4. Настройки CloudKit в Xcode
