# iCloud Sync Implementation

## Обзор реализации

Реализована полная синхронизация данных между устройствами через iCloud CloudKit с поддержкой:

- ✅ Синхронизация всех типов данных (компания, клиенты, продукты, инвойсы, настройки)
- ✅ Синхронизация PDF и вложений
- ✅ Разрешение конфликтов по принципу "последний апдейт побеждает"
- ✅ Real-time синхронизация между устройствами
- ✅ Работа в офлайн режиме с последующей синхронизацией
- ✅ Восстановление данных после переустановки приложения

## Архитектура

### 1. CloudKitManager
**Файл**: `Core/Services/CloudKitManager.swift`

Основной менеджер для синхронизации данных через CloudKit:

- Управление состоянием синхронизации
- Синхронизация всех типов данных
- Разрешение конфликтов
- Обработка ошибок

### 2. AttachmentSyncManager
**Файл**: `Core/Services/AttachmentSyncManager.swift`

Менеджер для синхронизации файлов и вложений:

- Синхронизация PDF файлов
- Синхронизация логотипов
- Управление вложениями
- Обработка больших файлов

### 3. AppState Integration
**Файл**: `Core/App/AppState.swift`

Интеграция синхронизации в основное состояние приложения:

- Автоматическая синхронизация при изменениях
- Обработка внешних изменений
- Управление состоянием синхронизации

### 4. SyncSettingsView
**Файл**: `Features/Settings/SyncSettingsView.swift`

Пользовательский интерфейс для управления синхронизацией:

- Статус подключения к iCloud
- Управление синхронизацией
- Диагностика проблем
- Обзор данных

## Ключевые особенности

### 1. Автоматическая синхронизация
```swift
@Published var company: Company? {
    didSet { 
        Storage.save(company, key: .company)
        syncToCloud() // Автоматическая синхронизация
    }
}
```

### 2. Разрешение конфликтов
```swift
private func resolveConflict(localRecord: CKRecord, cloudRecord: CKRecord) -> CKRecord {
    let localDate = localRecord["lastModified"] as? Date ?? Date.distantPast
    let cloudDate = cloudRecord["lastModified"] as? Date ?? Date.distantPast
    
    return cloudDate > localDate ? cloudRecord : localRecord
}
```

### 3. Синхронизация PDF
```swift
func syncPDF(for invoice: Invoice, pdfData: Data) async throws -> URL {
    let record = CKRecord(recordType: "Attachment", recordID: recordID)
    let asset = CKAsset(fileURL: tempURL)
    record["fileData"] = asset
    try await database.save(record)
}
```

### 4. Real-time уведомления
```swift
NotificationCenter.default.addObserver(
    forName: NSUbiquitousKeyValueStore.didChangeExternallyNotification,
    object: NSUbiquitousKeyValueStore.default,
    queue: .main
) { [weak self] _ in
    Task { @MainActor in self?.pullFromCloud() }
}
```

## Схема данных CloudKit

### Record Types

1. **Company** - Информация о компании
2. **Customer** - Данные клиентов
3. **Product** - Каталог продуктов
4. **Invoice** - Инвойсы
5. **PaymentMethod** - Методы оплаты
6. **Settings** - Настройки приложения
7. **Attachment** - Файлы и вложения

### Поля записей

Каждая запись содержит:
- `data` (Asset) - JSON данные
- `lastModified` (Date/Time) - время изменения

Записи вложений дополнительно содержат:
- `fileName` (String) - имя файла
- `fileType` (String) - тип файла
- `fileSize` (Int64) - размер файла
- `fileData` (Asset) - данные файла
- `associatedRecordID` (String) - ID связанной записи

## Пользовательский интерфейс

### 1. Карточка синхронизации в настройках
- Статус подключения к iCloud
- Время последней синхронизации
- Кнопка управления синхронизацией

### 2. Экран управления синхронизацией
- Детальный статус синхронизации
- Ручная синхронизация
- Обзор данных
- Диагностика проблем

## Тестирование

### 1. Тестирование синхронизации
1. Создайте данные на устройстве A
2. Проверьте появление данных на устройстве B
3. Внесите изменения на устройстве B
4. Проверьте синхронизацию на устройстве A

### 2. Тестирование конфликтов
1. Внесите изменения на обоих устройствах одновременно
2. Проверьте, что применяется последнее изменение
3. Убедитесь, что данные не теряются

### 3. Тестирование офлайн режима
1. Отключите интернет
2. Внесите изменения
3. Включите интернет
4. Проверьте синхронизацию

## Производительность

### 1. Оптимизации
- Ленивая загрузка данных
- Батчинг операций
- Кэширование локальных данных
- Сжатие изображений

### 2. Ограничения CloudKit
- Максимальный размер записи: 1MB
- Лимиты на количество запросов
- Ограничения на размер файлов

## Безопасность

### 1. Защита данных
- Все данные в приватной базе CloudKit
- Шифрование при передаче
- Доступ только для владельца Apple ID

### 2. Конфиденциальность
- Данные не передаются третьим лицам
- Полный контроль пользователя над данными
- Возможность удаления всех данных

## Мониторинг и диагностика

### 1. Логирование
- Детальные логи синхронизации
- Отслеживание ошибок
- Мониторинг производительности

### 2. Диагностика
- Проверка статуса iCloud
- Тестирование подключения
- Валидация данных

## Заключение

Реализована полнофункциональная система синхронизации данных через iCloud CloudKit, которая обеспечивает:

- Надежную синхронизацию между устройствами
- Сохранность данных при переустановке приложения
- Удобное управление синхронизацией
- Высокую производительность и безопасность

Система готова к использованию в продакшене и обеспечивает все требования из acceptance criteria.
